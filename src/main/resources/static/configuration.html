<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>线程池监控中心 - 配置页</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind自定义主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        info: '#1890FF',
                        purple: '#722ED1',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .stat-card {
                @apply bg-white rounded-lg p-4 shadow-sm transition-all duration-300 hover:shadow-md;
            }
            .config-card {
                @apply bg-white rounded-lg p-5 shadow-sm border border-gray-100 mb-6;
            }
            .nav-active {
                @apply text-primary border-primary font-medium;
            }
            .badge {
                @apply text-xs px-2 py-1 rounded-full font-medium;
            }
            .form-input {
                @apply block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary/20 transition duration-200;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark min-h-screen">
<!-- 顶部导航栏 -->
<header class="bg-white sticky top-0 z-50 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
            <div class="flex items-center space-x-2">
                <i class="fa fa-tasks text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800">线程池监控中心</h1>
            </div>

            <!-- 页面导航 -->
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 border-b-2 border-transparent hover:text-primary px-1 py-5 transition-colors">
                    <i class="fa fa-dashboard mr-1"></i> 监控页
                </a>
                <a href="configuration.html" class="nav-active border-b-2 px-1 py-5 transition-colors">
                    <i class="fa fa-cog mr-1"></i> 配置页
                </a>
            </nav>

            <!-- 移动端菜单按钮 -->
            <button class="md:hidden text-gray-600 hover:text-primary" id="mobile-menu-button">
                <i class="fa fa-bars text-xl"></i>
            </button>

            <!-- 状态信息 -->
            <div class="hidden md:flex items-center space-x-4">
                <div class="flex items-center text-sm text-gray-500">
                    <i class="fa fa-info-circle mr-2 text-primary"></i>
                    <span>配置修改将实时生效</span>
                </div>
            </div>
        </div>

        <!-- 移动端菜单 -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="flex flex-col space-y-3 pb-4">
                <a href="index.html" class="text-gray-600 hover:text-primary px-2 py-2 rounded-md">
                    <i class="fa fa-dashboard mr-1"></i> 监控页
                </a>
                <a href="configuration.html" class="nav-active px-2 py-2 rounded-md">
                    <i class="fa fa-cog mr-1"></i> 配置页
                </a>
                <div class="flex items-center pt-2 border-t border-gray-100 text-sm text-gray-500 px-2">
                    <i class="fa fa-info-circle mr-2 text-primary"></i>
                    <span>配置修改将实时生效</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- 主内容区 -->
<main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- 配置提示 -->
    <div class="bg-blue-50 border-l-4 border-primary p-4 mb-6 rounded-r">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fa fa-lightbulb-o text-primary"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-blue-700">
                    注意：修改线程池配置可能会影响系统性能，请根据实际需求谨慎调整。修改后配置将立即应用到当前运行的线程池。
                </p>
            </div>
        </div>
    </div>

    <!-- 最后更新时间 -->
    <div class="bg-gray-50 border border-gray-200 p-3 rounded-md mb-6 flex items-center justify-between">
        <div class="flex items-center text-sm">
            <i class="fa fa-clock-o text-gray-500 mr-2"></i>
            <span class="text-gray-600">最后更新时间:</span>
            <span class="ml-2 font-medium" id="last-updated">-</span>
        </div>
        <button id="refresh-config" class="text-sm text-primary hover:text-primary/80 flex items-center">
            <i class="fa fa-refresh mr-1"></i> 刷新配置
        </button>
    </div>

    <!-- 配置状态提示 -->
    <div id="config-message" class="hidden mb-6 p-4 rounded-md flex items-center">
        <i id="message-icon" class="mr-3 text-xl"></i>
        <span id="message-text"></span>
        <button id="close-message" class="ml-auto text-gray-500 hover:text-gray-700">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <!-- 线程参数配置 -->
    <div class="config-card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fa fa-sliders text-primary mr-2"></i> 线程参数配置
        </h2>
        <form id="worker-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label for="core-nums" class="form-label">核心线程数</label>
                    <input type="number" id="core-nums" name="coreNums" min="1" class="form-input px-3 py-2" required>
                    <p class="mt-1 text-xs text-gray-500">线程池维护的核心线程数量</p>
                </div>
                <div>
                    <label for="max-nums" class="form-label">最大线程数</label>
                    <input type="number" id="max-nums" name="maxNums" min="1" class="form-input px-3 py-2" required>
                    <p class="mt-1 text-xs text-gray-500">线程池允许的最大线程数量</p>
                </div>
                <div>
                    <label for="alive-time" class="form-label">线程空闲时间 (秒)</label>
                    <input type="number" id="alive-time" name="aliveTime" min="0" class="form-input px-3 py-2" required>
                    <p class="mt-1 text-xs text-gray-500">超过此时长的空闲线程将被回收，单位：秒</p>
                </div>
                <div class="flex items-end">
                    <div class="flex items-center">
                        <input type="checkbox" id="core-destroy" name="coreDestroy" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="core-destroy" class="ml-2 block text-sm text-gray-700">允许核心线程超时销毁</label>
                    </div>
                </div>
                <div class="flex items-end">
                    <div class="flex items-center">
                        <input type="checkbox" id="is-daemon" name="isDaemon" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="is-daemon" class="ml-2 block text-sm text-gray-700">使用守护线程</label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end pt-2">
                <button type="button" id="reset-worker" class="mr-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    重置
                </button>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    <i class="fa fa-save mr-1"></i> 保存线程配置
                </button>
            </div>
        </form>
    </div>

    <!-- 队列配置 -->
    <div class="config-card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fa fa-list-ol text-primary mr-2"></i> 队列配置
        </h2>
        <form id="queue-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="queue-name" class="form-label">队列名称</label>
                    <input type="text" id="queue-name" name="qName" class="form-input px-3 py-2" required>
                    <p class="mt-1 text-xs text-gray-500">输入队列实现类名称</p>
                </div>
                <div>
                    <label for="queue-capacity" class="form-label">队列容量</label>
                    <input type="number" id="queue-capacity" name="qCapacity" class="form-input px-3 py-2">
                    <p class="mt-1 text-xs text-gray-500">队列可容纳的最大任务数量，留空表示无限队列</p>
                </div>
            </div>
            <div class="flex justify-end pt-2">
                <button type="button" id="reset-queue" class="mr-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    重置
                </button>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    <i class="fa fa-save mr-1"></i> 保存队列配置
                </button>
            </div>
        </form>
    </div>

    <!-- 拒绝策略配置 -->
    <div class="config-card">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <i class="fa fa-ban text-primary mr-2"></i> 拒绝策略配置
        </h2>
        <form id="reject-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="reject-strategy" class="form-label">拒绝策略名称</label>
                    <input type="text" id="reject-strategy" name="rsName" class="form-input px-3 py-2" required>
                    <p class="mt-1 text-xs text-gray-500">输入拒绝策略实现类名称</p>
                </div>
                <div class="flex items-end">
                    <div class="bg-yellow-50 p-3 rounded border border-yellow-100 w-full">
                        <div class="flex">
                            <i class="fa fa-exclamation-triangle text-yellow-500 mt-0.5"></i>
                            <p class="ml-2 text-sm text-yellow-700">
                                注意：不同的拒绝策略会影响系统在高负载下的表现，请根据业务需求选择。输入错误的策略名称会导致配置失败。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end pt-2">
                <button type="button" id="reset-reject" class="mr-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    重置
                </button>
                <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-200">
                    <i class="fa fa-save mr-1"></i> 保存拒绝策略
                </button>
            </div>
        </form>
    </div>
</main>

<!-- 页脚 -->
<footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center text-sm text-gray-500">
            <p>线程池监控系统 &copy; 2023 - 配置修改将实时生效</p>
        </div>
    </div>
</footer>

<script>
    // 存储原始配置数据，用于重置功能
    let originalConfig = {
        worker: {},
        queue: {},
        reject: {}
    };

    document.addEventListener('DOMContentLoaded', function() {
        // 绑定事件
        bindEvents();

        // 加载当前配置
        loadCurrentConfig();
    });

    // 绑定事件
    function bindEvents() {
        // 移动端菜单切换
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // 关闭消息提示
        document.getElementById('close-message').addEventListener('click', function() {
            document.getElementById('config-message').classList.add('hidden');
        });

        // 刷新配置按钮
        document.getElementById('refresh-config').addEventListener('click', function() {
            const icon = this.querySelector('i');
            icon.classList.add('fa-spin');
            loadCurrentConfig().then(() => {
                icon.classList.remove('fa-spin');
                showMessage('配置已刷新', 'success');
            }).catch(() => {
                icon.classList.remove('fa-spin');
            });
        });

        // 表单提交事件
        document.getElementById('worker-form').addEventListener('submit', function(e) {
            e.preventDefault();
            saveWorkerConfig();
        });

        document.getElementById('queue-form').addEventListener('submit', function(e) {
            e.preventDefault();
            saveQueueConfig();
        });

        document.getElementById('reject-form').addEventListener('submit', function(e) {
            e.preventDefault();
            saveRejectConfig();
        });

        // 重置按钮事件
        document.getElementById('reset-worker').addEventListener('click', resetWorkerForm);
        document.getElementById('reset-queue').addEventListener('click', resetQueueForm);
        document.getElementById('reset-reject').addEventListener('click', resetRejectForm);
    }

    // 加载当前配置
    function loadCurrentConfig() {
        return fetchCurrentConfig().then(config => {
            // 保存原始配置
            originalConfig = { ...config };

            // 更新表单
            updateWorkerForm(config.worker);
            updateQueueForm(config.queue);
            updateRejectForm(config.reject);

            // 更新最后更新时间
            updateLastUpdatedTime();
            return true;
        }).catch(error => {
            showMessage('加载配置失败，请刷新页面重试', 'error');
            console.error('加载配置失败:', error);
            return false;
        });
    }

    // 获取当前配置
    function fetchCurrentConfig() {
        // 实际应用中应该从API获取
        return new Promise(resolve => {
            setTimeout(() => {
                resolve({
                    worker: {
                        coreNums: 5,
                        maxNums: 10,
                        coreDestroy: false,
                        aliveTime: 60,  // 单位为秒
                        isDaemon: false
                    },
                    queue: {
                        qName: "",
                        qCapacity: null  // 示例：null表示无限队列
                    },
                    reject: {
                        rsName: ""
                    }
                });
            }, 500);
        });
    }

    // 更新线程参数表单
    function updateWorkerForm(data) {
        document.getElementById('core-nums').value = data.coreNums || '';
        document.getElementById('max-nums').value = data.maxNums || '';
        document.getElementById('alive-time').value = data.aliveTime || '';  // 单位为秒
        document.getElementById('core-destroy').checked = data.coreDestroy || false;
        document.getElementById('is-daemon').checked = data.isDaemon || false;
    }

    // 更新队列表单
    function updateQueueForm(data) {
        document.getElementById('queue-name').value = data.qName || '';
        // 如果队列容量是null，则显示为空
        document.getElementById('queue-capacity').value = data.qCapacity !== null ? data.qCapacity : '';
    }

    // 更新拒绝策略表单
    function updateRejectForm(data) {
        document.getElementById('reject-strategy').value = data.rsName || '';
    }

    // 保存线程参数配置 - 参数通过URL查询字符串传递
    function saveWorkerConfig() {
        const formData = {
            coreNums: parseInt(document.getElementById('core-nums').value),
            maxNums: parseInt(document.getElementById('max-nums').value),
            coreDestroy: document.getElementById('core-destroy').checked,
            aliveTime: parseInt(document.getElementById('alive-time').value),
            isDaemon: document.getElementById('is-daemon').checked
        };

        // 验证核心线程数不能大于最大线程数
        if (formData.coreNums > formData.maxNums) {
            showMessage('核心线程数不能大于最大线程数', 'error');
            return;
        }

        // 将参数转换为查询字符串
        const params = new URLSearchParams();
        Object.entries(formData).forEach(([key, value]) => {
            params.append(key, value);
        });

        // 发送请求保存配置（参数在URL中）
        fetch(`http://localhost:8080/monitor/worker?${params}`, {
            method: 'PUT'
        })
            .then(response => response.json())
            .then(success => {
                if (success) {
                    originalConfig.worker = { ...formData };
                    showMessage('线程参数配置保存成功', 'success');
                    updateLastUpdatedTime();
                } else {
                    showMessage('线程参数配置保存失败，请重试', 'error');
                }
            })
            .catch(error => {
                showMessage('保存失败，网络错误', 'error');
                console.error('保存线程配置失败:', error);
            });
    }

    // 保存队列配置 - 允许队列容量为null表示无限队列
    function saveQueueConfig() {
        const queueCapacity = document.getElementById('queue-capacity').value.trim();

        const formData = {
            qName: document.getElementById('queue-name').value.trim(),
            // 如果队列为空，则设置为null表示无限队列
            qCapacity: queueCapacity === '' ? null : parseInt(queueCapacity)
        };

        // 简单验证
        if (!formData.qName) {
            showMessage('请输入队列名称', 'error');
            return;
        }

        // 将参数转换为查询字符串
        const params = new URLSearchParams();
        Object.entries(formData).forEach(([key, value]) => {
            // 对于null值，我们传递字符串"null"，后端需要正确解析
            params.append(key, value === null ? 'null' : value);
        });

        // 发送请求保存配置（参数在URL中）
        fetch(`http://localhost:8080/monitor/queue?${params}`, {
            method: 'PUT'
        })
            .then(response => response.json())
            .then(success => {
                if (success) {
                    originalConfig.queue = { ...formData };
                    showMessage('队列配置保存成功', 'success');
                    updateLastUpdatedTime();
                } else {
                    showMessage('队列配置保存失败，请检查队列名称是否正确', 'error');
                }
            })
            .catch(error => {
                showMessage('保存失败，网络错误', 'error');
                console.error('保存队列配置失败:', error);
            });
    }

    // 保存拒绝策略配置 - 参数通过URL查询字符串传递
    function saveRejectConfig() {
        const formData = {
            rsName: document.getElementById('reject-strategy').value.trim()
        };

        // 简单验证
        if (!formData.rsName) {
            showMessage('请输入拒绝策略名称', 'error');
            return;
        }

        // 将参数转换为查询字符串
        const params = new URLSearchParams();
        Object.entries(formData).forEach(([key, value]) => {
            params.append(key, value);
        });

        // 发送请求保存配置（参数在URL中）
        fetch(`http://localhost:8080/monitor/rejectStrategy?${params}`, {
            method: 'PUT'
        })
            .then(response => response.json())
            .then(success => {
                if (success) {
                    originalConfig.reject = { ...formData };
                    showMessage('拒绝策略配置保存成功', 'success');
                    updateLastUpdatedTime();
                } else {
                    showMessage('拒绝策略配置保存失败，请检查策略名称是否正确', 'error');
                }
            })
            .catch(error => {
                showMessage('保存失败，网络错误', 'error');
                console.error('保存拒绝策略配置失败:', error);
            });
    }

    // 重置表单
    function resetWorkerForm() {
        updateWorkerForm(originalConfig.worker);
    }

    function resetQueueForm() {
        updateQueueForm(originalConfig.queue);
    }

    function resetRejectForm() {
        updateRejectForm(originalConfig.reject);
    }

    // 显示消息提示
    function showMessage(text, type) {
        const messageEl = document.getElementById('config-message');
        const iconEl = document.getElementById('message-icon');
        const textEl = document.getElementById('message-text');

        // 设置消息类型样式
        if (type === 'success') {
            messageEl.className = 'mb-6 p-4 rounded-md flex items-center bg-green-50 text-green-800';
            iconEl.className = 'mr-3 text-xl fa fa-check-circle text-green-500';
        } else if (type === 'error') {
            messageEl.className = 'mb-6 p-4 rounded-md flex items-center bg-red-50 text-red-800';
            iconEl.className = 'mr-3 text-xl fa fa-exclamation-circle text-red-500';
        }

        // 设置消息内容
        textEl.textContent = text;

        // 显示消息
        messageEl.classList.remove('hidden');

        // 5秒后自动隐藏
        setTimeout(() => {
            messageEl.classList.add('hidden');
        }, 5000);
    }

    // 更新最后更新时间
    function updateLastUpdatedTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        const dateStr = now.toLocaleDateString();
        const formattedTime = `${dateStr} ${timeStr}`;
        document.getElementById('last-updated').textContent = formattedTime;
    }
</script>
</body>
</html>
